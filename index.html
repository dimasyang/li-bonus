
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>李采紋績效獎金紀錄試算表</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2em; background: #f9f9f9; }
    h1 { color: #006080; }
    input, button { padding: 5px; margin: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    .header { margin-bottom: 20px; }
  </style>
</head>
<body>
  <h1>李采紋績效獎金紀錄試算表</h1>
  <ul style="background:#e8f8f5; padding:10px; border-left:4px solid #00aaaa;">
    <li>自取金額未達 3 萬：無獎金</li>
    <li>自取金額達 3 萬～6 萬：基礎獎金 1.5%</li>
    <li>自取金額達 6 萬～10 萬：獎金 2%</li>
    <li>自取金額達 10 萬以上：獎金 2% + 每滿 10 萬元額外獎金 $2000</li>
    <li>退貨率 = 0：額外獎金 $1000</li>
    <li>退貨率 < 1%：額外獎金 $600</li>
    <li>退貨率 < 3%：額外獎金 $300</li>
  </ul>

  <div class="header">
    <input type="date" id="dateInput">
    <input type="number" id="pickupInput" placeholder="自取金額">
    <input type="number" id="deliveriesInput" placeholder="出貨件數">
    <input type="number" id="returnsInput" placeholder="退貨件數">
    <button onclick="saveRecord()">儲存記錄</button>
    <button onclick="deleteSelected()">刪除選取</button>
    <button onclick="exportExcel()">匯出 Excel</button>
  </div>

  <div id="summary"></div>

  <table id="recordTable">
    <thead>
      <tr>
        <th><input type="checkbox" onclick="toggleSelectAll(this)"></th>
        <th>日期</th>
        <th>自取金額</th>
        <th>出貨件數</th>
        <th>退貨件數</th>
      </tr>
    </thead>
    <tbody id="recordBody"></tbody>
  </table>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDW92ClIQR6jeV3vnOyu1Vh3ZH4AKWEdu0",
      authDomain: "lichaiwen-bonus.firebaseapp.com",
      projectId: "lichaiwen-bonus",
      storageBucket: "lichaiwen-bonus.firebasestorage.app",
      messagingSenderId: "658609795911",
      appId: "1:658609795911:web:96cde0742f7d48da555262",
      measurementId: "G-F5ESF7T4J4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function saveRecord() {
      const date = document.getElementById("dateInput").value;
      const pickup = Number(document.getElementById("pickupInput").value);
      const deliveries = Number(document.getElementById("deliveriesInput").value);
      const returns = Number(document.getElementById("returnsInput").value);
      if (!date) return alert("請輸入日期");
      await db.collection("records").add({ date, pickup, deliveries, returns });
      location.reload();
    }

    function toggleSelectAll(checkbox) {
      document.querySelectorAll('input[type="checkbox"].row-check').forEach(cb => cb.checked = checkbox.checked);
    }

    async function deleteSelected() {
      const checkboxes = document.querySelectorAll('input.row-check:checked');
      for (let cb of checkboxes) {
        await db.collection("records").doc(cb.dataset.id).delete();
      }
      location.reload();
    }

    function exportExcel() {
      const table = document.getElementById("recordTable");
      const wb = XLSX.utils.table_to_book(table, { sheet: "Sheet1" });
      XLSX.writeFile(wb, "bonus_records.xlsx");
    }

    function updateSummary(records) {
      const now = new Date();
      const currentYear = now.getFullYear();
      const currentMonth = now.getMonth();

      const currentMonthRecords = records.filter(r => {
        const d = new Date(r.date);
        return d.getFullYear() === currentYear && d.getMonth() === currentMonth;
      });

      const total = currentMonthRecords.reduce((sum, r) => sum + r.pickup, 0);
      const totalDeliveries = currentMonthRecords.reduce((sum, r) => sum + r.deliveries, 0);
      const totalReturns = currentMonthRecords.reduce((sum, r) => sum + r.returns, 0);
      const returnRate = totalDeliveries > 0 ? (totalReturns / totalDeliveries) : 0;

      let bonus = 0;
      if (total >= 100000) bonus = total * 0.02;
      else if (total >= 60000) bonus = total * 0.02;
      else if (total >= 30000) bonus = total * 0.015;
      bonus += Math.floor(total / 100000) * 2000;

      if (returnRate === 0 && totalDeliveries > 0) bonus += 1000;
      else if (returnRate < 0.01) bonus += 600;
      else if (returnRate < 0.03) bonus += 300;

      document.getElementById("summary").innerText = `本月自取總額: $${total.toLocaleString()} 、退貨率: ${(returnRate * 100).toFixed(2)}% 、預估獎金: $${Math.round(bonus).toLocaleString()}`;
    }

    async function loadData() {
      const snapshot = await db.collection("records").get();
      const records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();
      const tbody = document.getElementById("recordBody");
      records.forEach(r => {
        const d = new Date(r.date);
        if (d.getFullYear() === currentYear && d.getMonth() === currentMonth) {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td><input type="checkbox" class="row-check" data-id="${r.id}"></td>
            <td>${r.date}</td>
            <td>${r.pickup}</td>
            <td>${r.deliveries}</td>
            <td>${r.returns}</td>
          `;
          tbody.appendChild(row);
        }
      });
      updateSummary(records);
    }

    loadData();
  </script>
</body>
</html>
